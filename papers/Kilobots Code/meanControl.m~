%%% Controlling mean of kilobots with light by using a webcam, by: Shiva
%%% Shahrokhi and Aaron T. Becker @ University of Houston, Robotic Swarm
%%% Control Lab.

% Using Arduino for our lamps, this is how we define arduino in Matlab:
a = arduino('/dev/tty.usbmodem1411','uno');
% Defining webcam
cam = webcam(2);

% We have 8 Relays.
%This is y direction Straigt 
RELAY1 = 7;
% This is x Direction Left
RELAY2 = 6;
%This is y direction backwards
RELAY3 = 5;
% This is X direction Right
RELAY4 = 4;

RELAY5 = 3;

RELAY6 = 2;
RELAY7 = 1;

%This Relay is used for flash for taking pictures.
RELAY8 = 0;

%These are the goal positions for Mean Control
goalX = 800;
goalY = 434;
epsilon = 30;
% We will do this until we reach the goal.
success = false;
writeDigitalPin(a, RELAY1, 0);
    pause (1);
    again =false;

while success == false
    if again== true
        writeDigitalPin(a, RELAY1, 0);
    pause (1);
    end
    %Turn the flash on for a while

    % Read in a webcam snapshot.
    originalImage = snapshot(cam);
    originalImage = imcrop(originalImage,[345 60 1110 850]);
    % make grayscale.
    originalImage = rgb2gray(originalImage);
    [centers, radii] = imfindcircles(originalImage,[12 20],'ObjectPolarity','dark','Sensitivity',0.91);
    M = mean(centers);
    V = var(centers);
    C = cov(centers);
    imshow(originalImage);
    h = viscircles(centers,radii);
    
    if isnan(M)== false
    hold on
    again = false;
    plot(M(1,1) , M(1,2),'*','Markersize',16);
    plot_gaussian_ellipsoid(M,C);
    plot(centers(:,1),centers(:,2),'+','Markersize',16);
    plot(goalX,goalY, '*', 'Markersize',16);

    
    writeDigitalPin(a, RELAY1, 1);
    
    if M(1,1) > goalX+epsilon
        writeDigitalPin(a, RELAY1,0);
        writeDigitalPin(a,RELAY3,1);
        pause(2);
    else if M(1,1) < goalX-epsilon
        writeDigitalPin(a, RELAY1,1);
        writeDigitalPin(a,RELAY3,0);
        pause(2);
        else 
            writeDigitalPin(a, RELAY1,1);
            writeDigitalPin(a,RELAY3,1);
            pause(2);
            goalX = 
        end
    end
    else 
        again = true;
    end

end

% Read in a webcam snapshot.

originalImage = snapshot(cam);



