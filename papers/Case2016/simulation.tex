
\section{Simulation}\label{sec:simulation}
This section examples four main challenges for pose and torque control of an object, arranged in increasing difficulty.  Each task uses a PD controller that uses the mean position and mean velocity to regulate the swarm's mean position,  as in \cite{ShahrokhiIROS2015}. The control input is the global force applied to each robot:
\begin{align}
u_x &= K_{p}(goal_x - \bar{x}) + K_{d}(0-\bar{v}_x) \nonumber\\
u_y &= K_{p}(goal_y  - \bar{y}) + K_{d}(0-\bar{v}_y)  \label{eq:PDcontrolPosition}
\end{align}
here $K_{p}$ is the proportional gain, and $K_{d}$ is the derivative gain.  
The swarm's average position is $(\bar{x},\bar{y})$ and mean velocity is $(\bar{v}_x,\bar{v}_y)$.  
Each task uses a different algorithm to select the swarm's goal position $(goal_x,goal_y)$.

\paragraph{Pure torque control} 
An object with a pivot point can rotate, but not translate. A door is a common example of an object with a pivot. A door can have an angular velocity but cannot translate. 
 If there was only one robot touching the object, the robot should push at the point which maximizes the moment arm, at the extreme end of the object furthest from the pivot point.
The optimal pushing location provides the maximum force, because it maximizes  $r$ in \eqref{eq:torque}.
However, given a swarm of robots, maximizing $r$ is no longer the optimal solution.  
If the swarm hit the object with its mean position at the extreme edge, half of the robots will miss the object and  the swarm will be torn apart.
Because few robots remain,  the force is significantly decreased and torque is not maximized.
 In our simulation, the swarm apples torque until the swarm's mean position is beyond the object.  At this point, the swarm will be regathered in a corner, a time-consuming task. 
 The key parameter of interest for a hinged door of length $L$ is $C/L$, where $C$ is the position along the door where the mean of the swarm will push.  The swarm is directed toward 
 
\begin{align}\nonumber
goal_x &= O_x + C \sin(O_{\theta}) \\
goal_y &= O_y + C \cos(O_{\theta})  \label{eq:TorqueControl}
\end{align}

 Fig. \ref{fig:LFig} illustrates how different values of $C$ result in different rates of turning. These simulations tested $C = \{1/2, 3/4, 5/8, 1\}L$  The fastest turning rates occurred with  $C =  5/8L$. 



\begin{figure}
\begin{center}
	\includegraphics[width=\columnwidth]{LFig.pdf}
\end{center}
\vspace{-1em}
\caption{\label{fig:LFig}
Simulation results from a swarm applying force to a hinged door. 
The swarm mean is steered toward a point $C$ units along the object from the pivot point. The red dashed line indicates the times that the swarm was in variance control mode.
 Simulation used 144 robots of diameter $0.2$ m with a standard deviation of less than $1.5$ m and an object length of $6$ m.
}
\vspace{-1em}
\end{figure}


\paragraph{Orientation of the object}
These simulations used a uniform density rectangle as the object. This object was 30$\times$ larger than the robots.
Using the pure torque control discussed in the previous paragraph, the orientation of the object can be controlled by applying force. 
The rectangular object is not pivoted, so it moves in addition to rotating. 
 The swarm still may split into multiple components.
  We use the hysteresis variance control from \cite{ShahrokhiIROS2015}  to gather the swarm when its variance grows too large. 
  The following control law chooses a goal position to regulate the orientation of the object.  In the following equation, $O_{\theta}$ is the orientation of the object's major axis. The object COM is at $(O_x,O_y)$.

Let $O_{\theta}$ = the orientation of the object's major axis, measured from the world $x$-axis.
\begin{align}\nonumber
goal_x = O_x +  K_{orient}  (O_{\theta} - goal_\theta ) \cos(O_{\theta}) \\
goal_y = O_y +  K_{orient}  ( O_{\theta} -goal_\theta  ) \sin(O_{\theta})
\end{align}
Here $K_{orient}$ is a positive gain on the control input.  


\begin{figure}
\begin{center}
	\includegraphics[width=\columnwidth]{Orientation.pdf}
\end{center}
\vspace{-1em}
\caption{\label{fig:OrientCont}
Plot demonstrating  orientation control of a rectangular object. The green line is the goal orientation.   When the plot traces are constant the swarm is no longer pushing the object and instead is being regathered in a corner of the workspace until the variance is below a desired threshold. 
}
\vspace{-1em}
\end{figure}

Fig. \ref{fig:OrientCont} illustrates this controller with different starting positions. When the plot traces are constant the swarm is no longer pushing the object and instead is being regathered in a corner of the workspace. 

\paragraph{Straight translation while regulating object orientation} \label{para:PureTranslation}

When the total force is applied perpendicular to the object and in line with the center of mass, according to Eq. \ref{eq:torque} there will be no torque. 
The following goal position for the mean position of the swarm regulates the object's orientation using $\Delta \theta$ for proportional feedback  to determine where to apply force.
$\Delta_\theta = goal_\theta - O_\theta$ is the difference between the goal angle and the current object angle.
 $K_\tau$ is a constant and $(O_x,O_y)$ is the position of the object's COM.
\begin{align}
goal_x &= O_x \nonumber \\
goal_y &= K_\tau \Delta\theta + O_y  \label{eq:TranslationAndOrientation}
\end{align}

 Fig. \ref{fig:Straight} shows how $\Delta \theta$ converges to zero with different initial configurations of the swarm. When the swam is above or below of the object the swarm applies a torque to the object.
 
 
\begin{figure}
\begin{center}
	\includegraphics[width=\columnwidth]{Straight.pdf}
\end{center}
\vspace{-1em}
\caption{\label{fig:Straight}
In this task, the swarm pushed the object in the $+x$ direction while trying to regulate the orientation to $goal\theta = 0^\circ$.
 The swarm can push the object without changing its orientation only if it pushes along a line intersecting the COM of the object.  A feedback control law regulates the object's orientation.
}
\vspace{-1em}
\end{figure}

\paragraph{Following straight trajectory while regulating object orientation} \label{para:PureTranslation}

Assume an arbitrary line that if the object face that direction, the swarm should apply perpendicular force to the object to get to the desired location with the desired orientation.  We want to keep the object on the trajectory while the orientation of the object is also kept as desired. For this purpose, we have to find the intersection of the object orientation axis and the line. If the equation of the line is $ax+by+c =0$, and we name this point $P$, it can be found as:

\begin{align}
P_x &= \frac{b(bO_x-aO_y)-ac}{a^2 + b^2},\\ \nonumber
P_y &= \frac{a(-bO_x+aO_y)-bc}{a^2 + b^2}
\end{align}

Then for keeping the object on trajectory, we will have the following goal position for correcting both perpendicular error and angle error while pushing the object:
\begin{align}
goal_x &= O_x+ K_p (O_x-P_x)+ K_\tau \frac{O_x-P_x}{||O_x-P_x||}\Delta\theta \nonumber \\
goal_y &= O_y+ K_p (O_y-P_y)+ K_\tau \frac{O_y-P_y}{||O_y-P_y||}\Delta\theta \label{eq:Regulate}
\end{align}

Fig. \ref{fig:regulateStraight} shows the position and orientation over time when the desired trajectory is the line $y = goal_y$. 
%TODO:  control law regulating distance from the straight line trajectory AND object orientation

%Perhaps: assume without loss of generality that the desired trajectory is the line $y = goal_y$

%\begin{align} \label{eq:StraightTrajectoryAndOrientation}
%goal_x &= O_x \nonumber \\
%goal_y &= O_y + K_\tau \Delta\theta  + K_p (O_y -  goal_y)
%\end{align}


%Shiva, you can do better than this, and write an equation to make the swarm follow an arbitrary line




\paragraph{Object pose control}
We designed two algorithms to control the position of the object.  
Each works by first controlling the orientation and then regulating that orientation while translating the object. 
An ideal approach might use pure translation moves by  pushing  the object with a contact point in line with the object's COM and the goal.
In practice the ideal approach fails because the swarm has multiple points of contact, these contacts slide along the object, and the swarm flows around the object, usually splitting into multiple components.
Instead, by applying force perpendicular to the object's long axis, splitting of the swarm is reduced. 
The na\"{i}ve approach we represented in Alg. \ref{alg:naivePoseControlApproach} is to push the object along the major axis until position error perpendicular to the major axis is zero, then push perpendicular to the minor axis until parallel error is zero. 
This na\"{i}ve approach works poorly on objects with large aspect ratios because the swarm flows past the object. 
Instead Alg. \ref{alg:PoseControl} seeks to always push the object perpendicular to the major axis, preventing the swarm from flowing around. 


\begin{algorithm}
\caption{PerpendicularPushesPoseControl}\label{alg:naivePoseControlApproach}
\begin{algorithmic}[1]
\Require $goal_x, goal_y, goal_{\theta},O_x, O_y, O_{\theta}$.
\State $\Delta x = goal_x - O_x$
\State $\Delta y = goal_y - O_y$
\State $d = sqrt(\Delta x^2 + \Delta y^2) $ \Comment{Distance to goal}
\While {d is decreasing}
\State Follow straight trajectory while regulating object orientation horizontally
\State Update $d$
\EndWhile
\State Follow straight trajectory while regulating object orientation vertically
\end{algorithmic}
\end{algorithm}



\begin{algorithm}
\caption{PoseControl}\label{alg:PoseControl}
\begin{algorithmic}[1]
\Require $goal_x, goal_y, goal_{\theta},O_x, O_y, O_{\theta}, C<1$.
\State $\Delta x = goal_x - O_x$
\State $s_x = O_x$ \Comment{Starting position}
\While {$O_x < s_x + C\Delta x $}
\State $goal_{\theta} = -goal_{\theta}$ \Comment{Having negative $\theta$ until some point}
\State Follow straight trajectory while regulating object orientation
\EndWhile
\State $goal_{\theta} = -goal_{\theta}$\Comment{Required $\theta$}
\State Follow straight trajectory while regulating object orientation
\end{algorithmic}
\end{algorithm}



The swarm pushes the object to an intermediate location, from where a ``Translate while regulating orientation" move can deliver the object to the goal pose. 
In order to achieve this goal, we have used hysteresis based variance control, and whenever the swarm variance is bigger than the maximum variance, it will go to the corner to regather itself. 
It will cause some delay, but it will most of the time avoid having a group of robots in front of the object. However; there is still some probability that a part of the swarm appears in front of the object, as we see in Fig. \ref{fig:PosControlFig} around $t=170$ the orientation of the object is affected when the swarm is trying to regather because a group of the robots are in front of the object. Fig. \ref{fig:PosScreenShot} shows screenshots of the simulation.

\begin{figure}
\begin{center}
	\includegraphics[width=1.07\columnwidth]{PosControl.eps}
\end{center}
\vspace{-2em}
\caption{\label{fig:PosControlFig} 
Pose control using algorithm XX.  The objects is delivered to a goal position and orientation. The parts that the position including orientation is not changing, the swarm is in variance control mode to avoid splitting as much as it is possible. 
}
\vspace{-1em}
\end{figure}

\begin{figure}
\begin{center}
	\includegraphics[width=\columnwidth]{PosControl.pdf}
\end{center}
\vspace{-2em}
\caption{\label{fig:PosScreenShot}
Different situations for position control of the block while controlling its orientation. In the first half of achieving the goal distance, goal angle is negative the required goal angle.
}
\vspace{-0.5em}
\end{figure}


